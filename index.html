<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Treino</title>
    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Wrench.svg/1200px-Wrench.svg.png">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans flex flex-col items-center min-h-screen p-4">
    <header class="w-full max-w-4xl text-center py-6 border-b border-gray-700">
        <h1 class="text-4xl font-extrabold text-orange-500">Gerador de Treino</h1>
        <p id="userInfoDisplay" class="mt-2 text-lg text-gray-400"></p>
    </header>

    <main class="w-full max-w-4xl mt-8">

        <div id="authContainer" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-center text-orange-400">Entre ou Crie Sua Conta</h2>
            <div class="mb-4">
                <label for="authEmail" class="block text-gray-300">Email</label>
                <input type="email" id="authEmail" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1" placeholder="seuemail@exemplo.com">
            </div>
            <div class="mb-6">
                <label for="authPassword" class="block text-gray-300">Senha</label>
                <input type="password" id="authPassword" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1" placeholder="Sua Senha">
            </div>
            <button onclick="handleAuth()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Login / Criar Conta
            </button>
            <p id="authMessage" class="mt-4 text-center text-red-400"></p>
        </div>

        <div id="appContent" style="display: none;">
            
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <button id="logoutButton" onclick="logout()" class="w-full sm:w-auto bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200" style="display: none;">
                    Logout
                </button>
                <button id="upgradePremiumButton" onclick="upgradeToPremium()" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200" style="display: none;">
                    Tornar-se Premium (Simula√ß√£o)
                </button>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4 text-orange-400">Dados do Aluno</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nomeAluno" class="block text-gray-300">Nome do Aluno</label>
                        <input type="text" id="nomeAluno" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                    </div>
                    <div>
                        <label for="idade" class="block text-gray-300">Idade</label>
                        <input type="number" id="idade" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                    </div>
                    <div>
                        <label for="peso" class="block text-gray-300">Peso (kg)</label>
                        <input type="number" id="peso" step="0.1" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                    </div>
                    <div>
                        <label for="altura" class="block text-gray-300">Altura (cm)</label>
                        <input type="number" id="altura" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                    </div>
                    <div>
                        <label for="sexo" class="block text-gray-300">Sexo</label>
                        <select id="sexo" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                        </select>
                    </div>
                    <div>
                        <label for="nivel" class="block text-gray-300">N√≠vel</label>
                        <select id="nivel" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                            <option value="Iniciante">Iniciante</option>
                            <option value="Intermediario">Intermedi√°rio</option>
                            <option value="Avancado">Avan√ßado</option>
                        </select>
                    </div>
                    <div>
                        <label for="objetivo" class="block text-gray-300">Objetivo</label>
                        <select id="objetivo" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                            <option value="Hipertrofia">Hipertrofia</option>
                            <option value="Emagrecimento">Emagrecimento</option>
                            <option value="Resistencia">Resist√™ncia</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-xl mt-6">
                <h2 class="text-2xl font-bold mb-4 text-orange-400">Equipamentos Dispon√≠veis</h2>
                <div id="equipamentos" class="flex flex-wrap gap-4">
                    <div class="flex items-center"><input type="checkbox" id="equi-livre" value="Peso Livre" checked class="form-checkbox h-5 w-5 text-orange-600"><label for="equi-livre" class="ml-2">Peso Livre (Barras, Halteres)</label></div>
                    <div class="flex items-center"><input type="checkbox" id="equi-maquinas" value="M√°quinas" checked class="form-checkbox h-5 w-5 text-orange-600"><label for="equi-maquinas" class="ml-2">M√°quinas</label></div>
                    <div class="flex items-center"><input type="checkbox" id="equi-cabos" value="Cabos" checked class="form-checkbox h-5 w-5 text-orange-600"><label for="equi-cabos" class="ml-2">Cabos</label></div>
                    <div class="flex items-center"><input type="checkbox" id="equi-faixa" value="Faixa El√°stica" class="form-checkbox h-5 w-5 text-orange-600"><label for="equi-faixa" class="ml-2">Faixa El√°stica</label></div>
                    <div class="flex items-center"><input type="checkbox" id="equi-peso-corporal" value="Peso Corporal" checked class="form-checkbox h-5 w-5 text-orange-600"><label for="equi-peso-corporal" class="ml-2">Peso Corporal</label></div>
                    <div class="flex items-center"><input type="checkbox" id="equi-outros" value="Outros" class="form-checkbox h-5 w-5 text-orange-600"><label for="equi-outros" class="ml-2">Outros</label></div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-xl mt-6">
                <h2 class="text-2xl font-bold mb-4 text-orange-400">T√©cnicas de Treino (Opcional)</h2>
                <div id="tecnicas" class="flex flex-wrap gap-4">
                    <div class="flex items-center"><input type="checkbox" id="tech-drop" value="Drop Set" class="form-checkbox h-5 w-5 text-orange-600"><label for="tech-drop" class="ml-2">Drop Set</label></div>
                    <div class="flex items-center"><input type="checkbox" id="tech-bi" value="Bi-set" class="form-checkbox h-5 w-5 text-orange-600"><label for="tech-bi" class="ml-2">Bi-set</label></div>
                    <div class="flex items-center"><input type="checkbox" id="tech-superset" value="Superset" class="form-checkbox h-5 w-5 text-orange-600"><label for="tech-superset" class="ml-2">Superset</label></div>
                    <div class="flex items-center"><input type="checkbox" id="tech-fst7" value="FST-7" class="form-checkbox h-5 w-5 text-orange-600"><label for="tech-fst7" class="ml-2">FST-7</label></div>
                    <div class="flex items-center"><input type="checkbox" id="tech-rest" value="Rest-Pause" class="form-checkbox h-5 w-5 text-orange-600"><label for="tech-rest" class="ml-2">Rest-Pause</label></div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-xl mt-6">
                <h2 class="text-2xl font-bold mb-4 text-orange-400">Divis√£o do Treino</h2>
                <p class="text-gray-400 mb-4">Selecione os grupos musculares para cada dia de treino.</p>
                <div id="customDaysContainer">
                    </div>
                <button type="button" onclick="addCustomDay()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition duration-200">
                    Adicionar Dia de Treino
                </button>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl mt-6">
                <h2 class="text-2xl font-bold mb-4 text-orange-400">Observa√ß√µes</h2>
                <textarea id="observacoes" rows="4" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1" placeholder="Adicione observa√ß√µes importantes sobre o aluno..."></textarea>
            </div>
            
            <button onclick="gerarTreino()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg mt-6 text-xl transition duration-200">
                Gerar Treino
            </button>
            
            <button id="exportPdfButton" onclick="exportarTreinoParaPDF()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg mt-4 text-xl transition duration-200" disabled>
                Exportar para PDF (Premium)
            </button>

            <div id="resultado" class="mt-8 p-6 bg-gray-800 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-4 text-orange-400">Treino Gerado</h2>
                <p class="text-gray-400">Seu treino aparecer√° aqui ap√≥s ser gerado.</p>
            </div>
        </div>
    </main>

    <div id="genericModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center shadow-2xl">
            <p id="modalMessage" class="text-lg font-semibold mb-4 text-white"></p>
            <button onclick="closeModal()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Fechar
            </button>
        </div>
    </div>

    <div id="editExerciseModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-orange-400">Editar Exerc√≠cio</h3>
            <div class="mb-3">
                <label for="editExName" class="block text-gray-300">Nome do Exerc√≠cio</label>
                <input type="text" id="editExName" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
            </div>
            <div class="mb-3">
                <label for="editExSetsReps" class="block text-gray-300">S√©ries e Repeti√ß√µes (ex: 3x12)</label>
                <input type="text" id="editExSetsReps" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
            </div>
            <div class="mb-3">
                <label for="editExRest" class="block text-gray-300">Descanso (segundos)</label>
                <input type="number" id="editExRest" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
            </div>
            <div class="mb-4">
                <label for="editExTechnique" class="block text-gray-300">T√©cnica (Opcional)</label>
                <input type="text" id="editExTechnique" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="saveEditedExercise()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Salvar
                </button>
                <button onclick="closeModal('editExerciseModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="addExerciseToDayModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-orange-400">Adicionar Exerc√≠cio ao Dia</h3>
            <div class="mb-3">
                <label for="addExMuscleGroup" class="block text-gray-300">Grupo Muscular</label>
                <select id="addExMuscleGroup" onchange="updateAddExerciseGroupOptions()" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                </select>
            </div>
            <div class="mb-4">
                <label for="addExSelect" class="block text-gray-300">Exerc√≠cio</label>
                <select id="addExSelect" class="w-full bg-gray-700 text-white p-2 rounded-md mt-1">
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="addNewExerciseToDay()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Adicionar
                </button>
                <button onclick="closeModal('addExerciseToDayModal')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCEp3LGERFoAjYneefYA2JOZgt-1lQLhNM",
      authDomain: "gerador-de-treino.firebaseapp.com",
      projectId: "gerador-de-treino",
      storageBucket: "gerador-de-treino.appspot.com",
      messagingSenderId: "45578951281",
      appId: "1:45578951281:web:244eb312842cd147dc59d0",
      measurementId: "G-4XC1S57T4G"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let generatedTrainingPlan = [];
    let treinoGeradoConteudoParaPDF = {};
    let exerciciosDB = [];
    let userNivelAcesso = 'gratuito';
    const YOUR_LOGO_BASE64_STRING_HERE = '';
    const YOUR_GEMINI_API_KEY = "YOUR_GEMINI_API_KEY";

    const aquecimentos = {
        "Geral": [
            "5-10 minutos de cardio leve (esteira, bicicleta, el√≠ptico)",
            "Mobilidade articular (c√≠rculos com bra√ßos, rota√ß√£o de tronco, flex√£o de quadril)",
            "Alongamento din√¢mico (leg swings, arm circles)"
        ],
        "Peito": [
            "Rota√ß√£o de ombros",
            "Flex√µes de bra√ßo leves (em joelhos se necess√°rio)",
            "Alongamento de peitoral na parede"
        ],
        "Costas": [
            "Remada baixa com el√°stico ou peso leve",
            "Alongamento de grande dorsal",
            "Ativa√ß√£o escapular"
        ],
        "Pernas": [
            "Agachamento sem peso",
            "Eleva√ß√£o de joelhos",
            "Alongamento de isquiotibiais e quadr√≠ceps"
        ],
        "Gl√∫teos": [
            "Ponte de gl√∫teos",
            "Caminhada lateral com faixa el√°stica",
            "Alongamento de flexores do quadril"
        ],
        "Ombros": [
            "C√≠rculos com bra√ßos pequenos e grandes",
            "Rota√ß√£o interna/externa com el√°stico",
            "Eleva√ß√£o lateral com peso muito leve"
        ],
        "B√≠ceps": [
            "Rota√ß√£o de punhos",
            "Rosca direta com peso muito leve",
            "Alongamento suave de b√≠ceps"
        ],
        "Tr√≠ceps": [
            "Extens√£o de tr√≠ceps com peso muito leve",
            "Alongamento de tr√≠ceps",
            "Rota√ß√£o de ombros"
        ],
        "Abd√¥men": [
            "Rota√ß√£o de tronco",
            "Prancha leve (20-30 segundos)",
            "Alongamento de cobra"
        ],
        "Panturrilhas": [
            "Eleva√ß√£o de panturrilhas sem peso",
            "Alongamento de panturrilhas na parede"
        ],
        "Lombar": [
            "Gato-Camelo",
            "Rota√ß√£o lombar deitado",
            "Extens√£o lombar suave"
        ]
    };

    const cardioExercises = {
        "Iniciante": [
            { nome: "Caminhada R√°pida (30 min)", duracao: 30 },
            { nome: "Bicicleta Ergom√©trica (25 min, ritmo moderado)", duracao: 25 },
            { nome: "El√≠ptico (25 min, ritmo moderado)", duracao: 25 }
        ],
        "Intermediario": [
            { nome: "Corrida Moderada (20-30 min)", duracao: 20 },
            { nome: "Nata√ß√£o (25-35 min)", duracao: 25 },
            { nome: "Escada (20 min, ritmo constante)", duracao: 20 },
            { nome: "HIIT na esteira (15-20 min, 1:2 trabalho/descanso)", duracao: 15 }
        ],
        "Avancado": [
            { nome: "Corrida Intensa (30-45 min)", duracao: 30 },
            { nome: "HIIT (15-20 min, 1:1 ou 2:1 trabalho/descanso)", duracao: 15 },
            { nome: "Pular Corda (20-30 min, varia√ß√µes)", duracao: 20 },
            { nome: "Remo (25-35 min, alta intensidade)", duracao: 25 }
        ]
    };

    const tecnicasExplanations = {
        "Drop Set": "Ap√≥s atingir a falha em uma s√©rie, diminua o peso em 20-30% e continue at√© a falha novamente. Repita por 2-3 'quedas' de peso.",
        "Bi-set": "Realize dois exerc√≠cios diferentes para o mesmo grupo muscular (ou grupos musculares sinergistas) um ap√≥s o outro, sem descanso entre eles. Descanse ap√≥s ambos.",
        "Superset": "Realize dois exerc√≠cios para grupos musculares ANTAGONISTAS (ex: b√≠ceps e tr√≠ceps, peito e costas) um ap√≥s o outro, sem descanso. Descanse ap√≥s ambos.",
        "FST-7": "No final do treino de um grupo muscular, fa√ßa 7 s√©ries com 30-45 segundos de descanso entre cada uma, usando um peso moderado para atingir a falha ou pr√≥ximo dela em cada s√©rie.",
        "Rest-Pause": "Fa√ßa uma s√©rie at√© a falha ou perto dela, descanse por 10-20 segundos, e ent√£o fa√ßa mais algumas repeti√ß√µes com o mesmo peso at√© a falha novamente. Repita 1-2 vezes."
    };

    function getSeriesRepeticoes(objetivo, nivel) {
        let series, reps;

        switch (objetivo) {
            case "Hipertrofia":
                series = Math.floor(Math.random() * 2) + 3; // 3 ou 4 s√©ries
                if (nivel === "Iniciante") reps = "10-15";
                else if (nivel === "Intermediario") reps = "8-12";
                else reps = "6-10";
                break;
            case "Emagrecimento":
                series = Math.floor(Math.random() * 2) + 3; // 3 ou 4 s√©ries
                if (nivel === "Iniciante") reps = "12-18";
                else if (nivel === "Intermediario") reps = "15-20";
                else reps = "15-25";
                break;
            case "Resistencia":
                series = Math.floor(Math.random() * 2) + 2; // 2 ou 3 s√©ries
                if (nivel === "Iniciante") reps = "15-20";
                else if (nivel === "Intermediario") reps = "20-30";
                else reps = "25-40";
                break;
            default:
                series = 3;
                reps = "8-12";
        }
        return `${series}x${reps}`;
    }

    function getDescanso(objetivo) {
        switch (objetivo) {
            case "Hipertrofia": return "60-90 segundos";
            case "Emagrecimento": return "30-60 segundos";
            case "Resistencia": return "30-45 segundos";
            default: return "60 segundos";
        }
    }

    // --- Firebase Authentication ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            document.getElementById('userInfoDisplay').innerText = `Logado como: ${user.email}`;
            document.getElementById('logoutButton').style.display = 'block';
            loadExerciciosFromFirestore().then(() => {
                loadUserData(); // Load user data AFTER exercises are loaded
            }).catch(error => {
                console.error("Erro ao carregar exerc√≠cios do Firestore:", error);
                showModal("Erro ao carregar a lista de exerc√≠cios. Tente novamente mais tarde.");
            });
        } else {
            currentUser = null;
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('userInfoDisplay').innerText = '';
            document.getElementById('logoutButton').style.display = 'none';
        }
    });

    async function loadExerciciosFromFirestore() {
        try {
            const snapshot = await db.collection('exercicios').get();
            exerciciosDB = snapshot.docs.map(doc => doc.data());
            console.log(`Carregados ${exerciciosDB.length} exerc√≠cios do Firestore.`);
        } catch (error) {
            console.error("Erro ao carregar exerc√≠cios do Firestore:", error);
            throw error;
        }
    }

    async function handleAuth() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const authMessage = document.getElementById('authMessage');

        if (!email || !password) {
            authMessage.innerText = "Por favor, preencha email e senha.";
            return;
        }

        try {
            // Try to sign in
            await auth.signInWithEmailAndPassword(email, password);
            authMessage.innerText = "Login realizado com sucesso!";
        } catch (error) {
            // If sign in fails, try to create an account
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    // NOVO C√ìDIGO AQUI: Adiciona o campo 'nivelAcesso' para novos usu√°rios
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email: email,
                        nivelAcesso: 'gratuito'
                    }, { merge: true });

                    authMessage.innerText = "Conta criada e login realizado com sucesso!";
                } catch (createError) {
                    authMessage.innerText = `Erro ao criar conta: ${createError.message}`;
                }
            } else {
                authMessage.innerText = `Erro de autentica√ß√£o: ${error.message}`;
            }
        }
    }

    async function logout() {
        try {
            await auth.signOut();
            showModal("Voc√™ foi desconectado.");
        } catch (error) {
            console.error("Erro ao fazer logout:", error);
            showModal(`Erro ao fazer logout: ${error.message}`);
        }
    }

    async function saveUserData() {
        if (!currentUser) {
            console.warn("Nenhum usu√°rio logado para salvar dados.");
            return;
        }

        const nomeAluno = document.getElementById('nomeAluno').value;
        const idade = document.getElementById('idade').value;
        const peso = document.getElementById('peso').value;
        const altura = document.getElementById('altura').value;
        const sexo = document.getElementById('sexo').value;
        const nivel = document.getElementById('nivel').value;
        const objetivo = document.getElementById('objetivo').value;
        const observacoes = document.getElementById('observacoes').value;

        const equipamentos = Array.from(document.querySelectorAll('#equipamentos input[type="checkbox"]:checked'))
                                 .map(cb => cb.value);
        const tecnicas = Array.from(document.querySelectorAll('#tecnicas input[type="checkbox"]:checked'))
                              .map(cb => cb.value);

        const customDaysData = [];
        document.querySelectorAll('.custom-day-entry').forEach(dayDiv => {
            const dayLabel = dayDiv.getAttribute('data-day-label');
            const selectedGroups = Array.from(dayDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                        .map(cb => cb.value);
            customDaysData.push({ dayLabel, selectedGroups });
        });
        
        try {
            await db.collection('users').doc(currentUser.uid).set({
                nomeAluno, idade, peso, altura, sexo, nivel, objetivo,
                equipamentos, tecnicas, observacoes, customDaysData,
                generatedTrainingPlan
            }, { merge: true });
            console.log("Dados do usu√°rio e treino salvos com sucesso!");
        } catch (error) {
            console.error("Erro ao salvar dados do usu√°rio:", error);
            showModal(`Erro ao salvar dados: ${error.message}`);
        }
    }

    async function loadUserData() {
        if (!currentUser) {
            console.warn("Nenhum usu√°rio logado para carregar dados.");
            return;
        }

        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                const data = doc.data();
                userNivelAcesso = data.nivelAcesso || 'gratuito';
                const exportPdfButton = document.getElementById('exportPdfButton');
                const upgradePremiumButton = document.getElementById('upgradePremiumButton');
                
                if (userNivelAcesso === 'gratuito') {
                    exportPdfButton.disabled = true;
                    exportPdfButton.innerText = "Exportar para PDF (Premium)";
                    if(upgradePremiumButton) upgradePremiumButton.style.display = 'block';
                } else {
                    exportPdfButton.disabled = false;
                    exportPdfButton.innerText = "Exportar para PDF";
                    if(upgradePremiumButton) upgradePremiumButton.style.display = 'none';
                }

                document.getElementById('nomeAluno').value = data.nomeAluno || '';
                document.getElementById('idade').value = data.idade || '';
                document.getElementById('peso').value = data.peso || '';
                document.getElementById('altura').value = data.altura || '';
                document.getElementById('sexo').value = data.sexo || '';
                document.getElementById('nivel').value = data.nivel || '';
                document.getElementById('objetivo').value = data.objetivo || '';
                document.getElementById('observacoes').value = data.observacoes || '';

                const equipamentoCheckboxes = document.querySelectorAll('#equipamentos input[type="checkbox"]');
                equipamentoCheckboxes.forEach(cb => cb.checked = false);
                if (data.equipamentos) {
                    data.equipamentos.forEach(eq => {
                        const cb = document.querySelector(`#equipamentos input[value="${eq}"]`);
                        if (cb) cb.checked = true;
                    });
                }

                const tecnicaCheckboxes = document.querySelectorAll('#tecnicas input[type="checkbox"]');
                tecnicaCheckboxes.forEach(cb => cb.checked = false);
                if (data.tecnicas) {
                    data.tecnicas.forEach(tech => {
                        const cb = document.querySelector(`#tecnicas input[value="${tech}"]`);
                        if (cb) cb.checked = true;
                    });
                }

                document.getElementById('customDaysContainer').innerHTML = '';
                dayCounter = 0;
                if (data.customDaysData && data.customDaysData.length > 0) {
                    data.customDaysData.forEach(day => {
                        addCustomDay(day.dayLabel, day.selectedGroups);
                    });
                } else {
                    addCustomDay();
                }

                if (data.generatedTrainingPlan && data.generatedTrainingPlan.length > 0) {
                    generatedTrainingPlan = data.generatedTrainingPlan;
                    displayGeneratedTrainingPlan();
                } else {
                    document.getElementById('resultado').innerHTML = "<p class='text-gray-400'>Nenhum treino gerado ainda. Preencha os dados e clique em 'Gerar Treino'.</p>";
                }

            } else {
                addCustomDay();
            }
        } catch (error) {
            console.error("Erro ao carregar dados do usu√°rio:", error);
            showModal(`Erro ao carregar dados: ${error.message}`);
            addCustomDay();
        }
    }

    async function upgradeToPremium() {
        if (!currentUser) {
            showModal("Voc√™ precisa estar logado para atualizar seu plano.");
            return;
        }

        try {
            await db.collection('users').doc(currentUser.uid).update({
                nivelAcesso: 'premium'
            });
            showModal("Parab√©ns! Seu plano foi atualizado para Premium (Simula√ß√£o). Agora voc√™ pode exportar seus treinos para PDF!");
            userNivelAcesso = 'premium';
            document.getElementById('exportPdfButton').disabled = false;
            document.getElementById('exportPdfButton').innerText = "Exportar para PDF";
            document.getElementById('upgradePremiumButton').style.display = 'none';
        } catch (error) {
            console.error("Erro ao simular o upgrade para Premium:", error);
            showModal(`Ocorreu um erro ao atualizar seu plano: ${error.message}`);
        }
    }


    function displayGeneratedTrainingPlan() {
        let treinoOutputHTML = '';
        treinoGeradoConteudoParaPDF = {
            aluno: document.getElementById('nomeAluno').value,
            idade: document.getElementById('idade').value,
            peso: document.getElementById('peso').value,
            altura: document.getElementById('altura').value,
            sexo: document.getElementById('sexo').value,
            nivel: document.getElementById('nivel').value,
            objetivo: document.getElementById('objetivo').value,
            tecnicas: Array.from(document.querySelectorAll('#tecnicas input[type="checkbox"]:checked')).map(cb => cb.value),
            observacoes: document.getElementById('observacoes').value,
            dias: []
        };

        if (generatedTrainingPlan.length === 0) {
            document.getElementById('resultado').innerHTML = "<p class='text-gray-400'>Nenhum treino gerado ainda. Preencha os dados e clique em 'Gerar Treino'.</p>";
            return;
        }

        generatedTrainingPlan.forEach(day => {
            treinoOutputHTML += `<h3 class="text-xl font-bold mb-3 mt-6 text-orange-400">Dia ${day.dayLabel}: Treino de ${day.muscleGroups.join(' + ')}</h3>\n`;
            
            const selectedWarmup = getWarmup(day.muscleGroups);
            treinoOutputHTML += `<p class="font-semibold mt-4">Aquecimento Geral (5-10 min):</p>\n<ul class="list-disc list-inside ml-4 mb-4">`;
            selectedWarmup.forEach(item => {
                treinoOutputHTML += `<li>${item}</li>`;
            });
            treinoOutputHTML += `</ul>`;

            const exercisesForPdfTable = [];

            if (day.exercises.length === 0) {
                treinoOutputHTML += `<p class="text-red-300">N√£o foi poss√≠vel gerar exerc√≠cios para o Dia ${day.dayLabel}. Por favor, verifique a sua sele√ß√£o de grupos musculares, op√ß√µes de equipamentos e n√≠vel de treino para garantir que h√° exerc√≠cios dispon√≠veis.</p>\n`;
                exercisesForPdfTable.push({
                    nome: `N√£o foi poss√≠vel gerar exerc√≠cios para este dia.`,
                    equipamento: "",
                    execucao: "Verifique a configura√ß√£o.",
                    descanso: "",
                    tecnica: ""
                });
            } else {
                let currentDayHtmlExercises = [];
                day.exercises.forEach((exercicio, index) => {
                    const execucaoText = `${exercicio.series}x${exercicio.reps}`;
                    const descansoText = `${exercicio.descanso} segundos`;
                    const tecnicaText = exercicio.tecnica ? ` | T√©cnica: ${exercicio.tecnica}` : '';
                    
                    currentDayHtmlExercises.push(`
                        <li class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-gray-600 p-3 rounded-md mb-2">
                            <div>
                                <strong class="text-yellow-300">${exercicio.nome}</strong> <span class="text-sm text-gray-300">(${exercicio.equipamento})</span> - ${execucaoText} ${tecnicaText}
                            </div>
                            <div class="flex gap-2 mt-2 sm:mt-0">
                                <button onclick="openEditExerciseModal('${day.dayLabel}', ${index})" class="bg-blue-600 hover:bg-blue-700 text-white text-xs py-1 px-2 rounded">Editar</button>
                                <button class="remove bg-red-600 hover:bg-red-700 text-white text-xs py-1 px-2 rounded" onclick="removeExerciseFromGeneratedPlan('${day.dayLabel}', ${index})">Remover</button>
                            </div>
                        </li>
                    `);

                    exercisesForPdfTable.push({
                        nome: exercicio.nome,
                        equipamento: exercicio.equipamento,
                        execucao: execucaoText,
                        descanso: descansoText,
                        tecnica: exercicio.tecnica || '-'
                    });
                });
                treinoOutputHTML += `<p class="font-semibold mt-4">üí™ Treino de For√ßa:</p><ul class="mb-4">${currentDayHtmlExercises.join('\n')}</ul>`;
            }
            
            treinoOutputHTML += `<button onclick="openAddExerciseToDayModal('${day.dayLabel}')" class="py-2 px-4 rounded-lg text-white font-bold text-base bg-blue-600 hover:bg-blue-700 mt-2">Adicionar Exerc√≠cio Manualmente</button>`;


            const currentDayPdfData = {
                dayName: day.dayLabel,
                groups: day.muscleGroups,
                warmup: selectedWarmup,
                exercises: exercisesForPdfTable,
                cardio: day.cardio,
            };
            treinoGeradoConteudoParaPDF.dias.push(currentDayPdfData);


            if (day.cardio) {
                treinoOutputHTML += `<p class="font-semibold mt-4">üèÉ Cardio: <span class="font-normal">${day.cardio}</span></p>\n`;
            } else {
                 treinoOutputHTML += `<p class="text-gray-400 font-semibold mt-4">üèÉ Cardio: <span class="font-normal">Nenhum exerc√≠cio de cardio gerado para este dia.</span></p>\n`;
            }

            treinoOutputHTML += `\n<hr class="my-6 border-gray-500">\n`;
        });
        document.getElementById('resultado').innerHTML = treinoOutputHTML;
    }

    // --- Modal Functions ---
    function showModal(message, modalId = 'genericModal') {
        document.getElementById('modalMessage').innerText = message;
        document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId = 'genericModal') {
        document.getElementById(modalId).style.display = 'none';
    }

    let currentEditDayLabel = '';
    let currentEditExerciseIndex = -1;

    function openEditExerciseModal(dayLabel, exerciseIndex) {
        currentEditDayLabel = dayLabel;
        currentEditExerciseIndex = exerciseIndex;

        const day = generatedTrainingPlan.find(d => d.dayLabel === dayLabel);
        if (day) {
            const exercise = day.exercises[exerciseIndex];
            if (exercise) {
                document.getElementById('editExName').value = exercise.nome;
                document.getElementById('editExSetsReps').value = `${exercise.series}x${exercise.reps}`;
                document.getElementById('editExRest').value = exercise.descanso;
                document.getElementById('editExTechnique').value = exercise.tecnica || '';
                showModal('', 'editExerciseModal');
            } else {
                showModal("Erro: Exerc√≠cio n√£o encontrado para edi√ß√£o.", 'genericModal');
            }
        } else {
            showModal("Erro: Dia de treino n√£o encontrado para edi√ß√£o.", 'genericModal');
        }
    }

    function saveEditedExercise() {
        if (currentEditDayLabel && currentEditExerciseIndex !== -1) {
            const day = generatedTrainingPlan.find(d => d.dayLabel === currentEditDayLabel);
            if (day) {
                const exercise = day.exercises[currentEditExerciseIndex];
                if (exercise) {
                    const newName = document.getElementById('editExName').value;
                    const setsReps = document.getElementById('editExSetsReps').value.split('x');
                    const newRest = parseInt(document.getElementById('editExRest').value);
                    const newTechnique = document.getElementById('editExTechnique').value;

                    if (!newName || setsReps.length !== 2 || isNaN(parseInt(setsReps[0])) || isNaN(newRest)) {
                        showModal("Por favor, preencha todos os campos corretamente (S√©ries/Repeti√ß√µes como 'NxM', Descanso como n√∫mero).");
                        return;
                    }

                    exercise.nome = newName;
                    exercise.series = parseInt(setsReps[0]);
                    exercise.reps = setsReps[1].trim();
                    exercise.descanso = newRest;
                    exercise.tecnica = newTechnique;
                    
                    displayGeneratedTrainingPlan();
                    saveUserData();
                    showModal("Exerc√≠cio atualizado com sucesso!", 'genericModal');
                    closeModal('editExerciseModal');
                }
            }
        }
    }

    function removeExerciseFromGeneratedPlan(dayLabel, exerciseIndex) {
        const day = generatedTrainingPlan.find(d => d.dayLabel === dayLabel);
        if (day) {
            const removedExercise = day.exercises.splice(exerciseIndex, 1)[0];

            if (removedExercise.tecnica === 'Bi-set' || removedExercise.tecnica === 'Superset') {
                let pairedIndex = -1;
                if (removedExercise.nome.includes('(Conjugado com')) {
                    const originalName = removedExercise.nome.match(/\(Conjugado com (.*?)\)/);
                    if (originalName && originalName[1]) {
                        pairedIndex = day.exercises.findIndex(ex => ex.nome === originalName[1] && (ex.tecnica === 'Bi-set' || ex.tecnica === 'Superset'));
                    }
                } else if (removedExercise.pairedExercise) {
                    const pairedName = removedExercise.pairedExercise.nome;
                    pairedIndex = day.exercises.findIndex(ex => ex.nome.includes(`(Conjugado com ${removedExercise.nome})`));
                }
                
                if (pairedIndex !== -1) {
                    day.exercises.splice(pairedIndex, 1);
                    showModal("Exerc√≠cio e seu par removidos com sucesso!", 'genericModal');
                } else {
                    showModal("Exerc√≠cio removido com sucesso!", 'genericModal');
                }
            } else {
                showModal("Exerc√≠cio removido com sucesso!", 'genericModal');
            }
            
            displayGeneratedTrainingPlan();
            saveUserData();
        }
    }
    
    let currentAddExerciseDayLabel = '';
    function openAddExerciseToDayModal(dayLabel) {
        currentAddExerciseDayLabel = dayLabel;
        populateAddExSelect();
        showModal('', 'addExerciseToDayModal');
    }

    function populateAddExSelect() {
        const addExMuscleGroupSelect = document.getElementById('addExMuscleGroup');
        addExMuscleGroupSelect.innerHTML = '<option value="">Selecione um Grupo</option>';
        const uniqueGroups = [...new Set(exerciciosDB.map(ex => ex.grupoPrimario))].sort();
        uniqueGroups.forEach(group => {
            const option = document.createElement('option');
            option.value = group;
            option.innerText = group;
            addExMuscleGroupSelect.appendChild(option);
        });
        updateAddExerciseGroupOptions();
    }

    function updateAddExerciseGroupOptions() {
        const selectedGroup = document.getElementById('addExMuscleGroup').value;
        const addExSelect = document.getElementById('addExSelect');
        addExSelect.innerHTML = '<option value="">Selecione um Exerc√≠cio</option>';

        const equipamentosSelecionados = Array.from(document.querySelectorAll('#equipamentos input[type="checkbox"]:checked'))
                                            .map(cb => cb.value);

        const filteredExercises = exerciciosDB.filter(ex =>
            (selectedGroup === "" || ex.grupoPrimario === selectedGroup) &&
            equipamentosSelecionados.some(eq => Array.isArray(ex.equipamento) ? ex.equipamento.includes(eq) : ex.equipamento === eq)
        );

        filteredExercises.sort((a, b) => a.nome.localeCompare(b.nome));

        filteredExercises.forEach(ex => {
            const option = document.createElement('option');
            option.value = ex.nome;
            option.innerText = `${ex.nome} (${Array.isArray(ex.equipamento) ? ex.equipamento.join(', ') : ex.equipamento})`;
            addExSelect.appendChild(option);
        });
    }

    function addNewExerciseToDay() {
        const selectedExerciseName = document.getElementById('addExSelect').value;
        if (!selectedExerciseName) {
            showModal("Por favor, selecione um exerc√≠cio para adicionar.");
            return;
        }

        const day = generatedTrainingPlan.find(d => d.dayLabel === currentAddExerciseDayLabel);
        if (!day) {
            showModal("Erro: Dia de treino n√£o encontrado.");
            return;
        }

        const exerciseToAdd = exerciciosDB.find(ex => ex.nome === selectedExerciseName);
        if (!exerciseToAdd) {
            showModal("Erro: Exerc√≠cio selecionado n√£o encontrado na base de dados (Firestore).");
            return;
        }

        const isAlreadyAdded = day.exercises.some(ex => ex.nome.replace(/\s\(Conjugado com.*?\)/, '') === exerciseToAdd.nome);
        if (isAlreadyAdded) {
            showModal("Este exerc√≠cio j√° foi adicionado a este dia.");
            return;
        }

        const nivel = document.getElementById('nivel').value;
        const objetivo = document.getElementById('objetivo').value;

        const newExerciseEntry = {
            nome: exerciseToAdd.nome,
            equipamento: Array.isArray(exerciseToAdd.equipamento) ? exerciseToAdd.equipamento.join(', ') : exerciseToAdd.equipamento,
            series: parseInt(getSeriesRepeticoes(objetivo, nivel).split('x')[0]),
            reps: getSeriesRepeticoes(objetivo, nivel).split('x')[1],
            descanso: parseInt(getDescanso(objetivo).replace(' segundos', '')),
            tecnica: '',
            pairedExercise: null
        };

        day.exercises.push(newExerciseEntry);
        displayGeneratedTrainingPlan();
        saveUserData();
        showModal("Exerc√≠cio adicionado com sucesso!", 'genericModal');
        closeModal('addExerciseToDayModal');
    }


    // --- Custom Day Management ---
    let dayCounter = 0;
    const allMuscleGroups = ["Peito", "Costas", "Pernas", "Gl√∫teos", "Ombros", "B√≠ceps", "Tr√≠ceps", "Abd√¥men", "Panturrilhas", "Antebra√ßo", "Trap√©zio", "Lombar", "Posterior Coxa", "Quadr√≠ceps", "Adutores", "Core"];

    function getDayLetter(num) {
        const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        return letters[num % letters.length];
    }

    function addCustomDay(dayLabelFromLoad = null, selectedGroupsFromLoad = []) {
        const container = document.getElementById('customDaysContainer');
        const dayIndex = dayCounter++;

        const diaLetra = dayLabelFromLoad || getDayLetter(dayIndex);

        const dayDiv = document.createElement('div');
        dayDiv.className = 'custom-day-entry bg-gray-700 p-4 rounded-lg mb-3';
        dayDiv.setAttribute('data-day-label', diaLetra); 

        let checkboxesHtml = allMuscleGroups.map(group => `
            <div class="flex items-center">
                <input type="checkbox" id="day-${diaLetra}-${group}-${dayIndex}" value="${group}" class="form-checkbox h-5 w-5 text-orange-600" ${selectedGroupsFromLoad.includes(group) ? 'checked' : ''}>
                <label for="day-${diaLetra}-${group}-${dayIndex}" class="ml-2 text-base">${group}</label>
            </div>
        `).join('');

        dayDiv.innerHTML = `
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
                <label class="text-lg font-bold">Dia <span class="day-label">${diaLetra}</span>: Grupos Musculares</label>
                <button type="button" class="remove-day-btn bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded-md text-sm mt-2 sm:mt-0" onclick="removeCustomDay(this, '${diaLetra}')">Remover Dia</button>
            </div>
            <div class="flex flex-wrap gap-4">
                ${checkboxesHtml}
            </div>
        `;
        container.appendChild(dayDiv);
    }

    function removeCustomDay(button, dayLabelToRemove) {
        const dayDiv = button.closest('.custom-day-entry');
        if (dayDiv) {
            dayDiv.remove();
            generatedTrainingPlan = generatedTrainingPlan.filter(day => day.dayLabel !== dayLabelToRemove);
            displayGeneratedTrainingPlan(); 
            saveUserData();
        }
    }

    function getWarmup(muscleGroups) {
        const generalWarmup = [...aquecimentos.Geral];
        const specificWarmup = new Set();

        muscleGroups.forEach(group => {
            if (aquecimentos[group]) {
                aquecimentos[group].forEach(item => specificWarmup.add(item));
            }
        });
        return [...generalWarmup, ...Array.from(specificWarmup)];
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function gerarTreino() {
        const nomeAluno = document.getElementById('nomeAluno').value;
        const idade = document.getElementById('idade').value;
        const peso = document.getElementById('peso').value;
        const altura = document.getElementById('altura').value;
        const sexo = document.getElementById('sexo').value;
        const nivel = document.getElementById('nivel').value;
        const objetivo = document.getElementById('objetivo').value;
        const observacoes = document.getElementById('observacoes').value;

        const equipamentosSelecionados = Array.from(document.querySelectorAll('#equipamentos input[type="checkbox"]:checked'))
                                            .map(cb => cb.value);

        const tecnicasSelecionadas = Array.from(document.querySelectorAll('#tecnicas input[type="checkbox"]:checked'))
                                         .map(cb => cb.value);

        if (!nomeAluno || !idade || !peso || !altura || !sexo || !nivel || !objetivo) {
            showModal("Por favor, preencha todos os campos obrigat√≥rios.");
            return;
        }
        if (equipamentosSelecionados.length === 0) {
            showModal("Por favor, selecione pelo menos um equipamento dispon√≠vel.");
            return;
        }
        if (exerciciosDB.length === 0) {
            showModal("A lista de exerc√≠cios n√£o foi carregada. Verifique sua conex√£o ou a configura√ß√£o do Firebase Firestore.");
            return;
        }


        const customDivisionsData = [];
        let hasSelectedGroups = false;
        document.querySelectorAll('.custom-day-entry').forEach(dayDiv => {
            const dayLabel = dayDiv.getAttribute('data-day-label');
            const selectedGroups = Array.from(dayDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                        .map(cb => cb.value);
            if (selectedGroups.length > 0) {
                hasSelectedGroups = true;
            }
            customDivisionsData.push({ dayLabel, selectedGroups });
        });

        if (!hasSelectedGroups) {
            showModal("Por favor, selecione os grupos musculares para pelo menos um dia de treino.");
            return;
        }

        generatedTrainingPlan = [];

        const maxTecnicasPorDia = 2;

        customDivisionsData.forEach(dia => {
            const diaLetra = dia.dayLabel;
            const gruposDoDia = dia.selectedGroups;
            let tecnicasAplicadasNesteDia = 0;
            const exerciciosJaUsadosNoDia = new Set();

            const currentDayExercises = [];

            if (gruposDoDia.length === 0) {
                 generatedTrainingPlan.push({
                    dayLabel: diaLetra,
                    muscleGroups: gruposDoDia,
                    exercises: [],
                    cardio: null,
                });
                return;
            }

            gruposDoDia.forEach(grupo => {
                const grupoPrimario = grupo;
                
                const exerciciosDisponiveis = exerciciosDB.filter(ex =>
                    ex.grupoPrimario === grupoPrimario &&
                    (nivel === "Avancado" || ex.difficulty === "Iniciante" || ex.difficulty === "Intermediario") &&
                    (nivel === "Intermediario" ? ex.difficulty !== "Avancado" : true) &&
                    equipamentosSelecionados.some(eq => Array.isArray(ex.equipamento) ? eq.includes(eq) : ex.equipamento === eq)
                );

                let numExerciciosPorGrupo;
                if (nivel === "Iniciante") numExerciciosPorGrupo = 2;
                else if (nivel === "Intermediario") numExerciciosPorGrupo = 3;
                else numExerciciosPorGrupo = 3;

                let shuffledExercicios = shuffleArray([...exerciciosDisponiveis]);
                let exercisesAddedForGroup = 0;

                for (let i = 0; i < shuffledExercicios.length && exercisesAddedForGroup < numExerciciosPorGrupo; i++) {
                    const exercicio = shuffledExercicios[i];
                    if (exerciciosJaUsadosNoDia.has(exercicio.nome)) {
                        continue;
                    }
                    
                    exerciciosJaUsadosNoDia.add(exercicio.nome);
                    exercisesAddedForGroup++;

                    const execucaoText = getSeriesRepeticoes(objetivo, nivel);
                    let tecnicaAplicada = '';
                    let pairedExerciseObj = null;

                    const applicableTechniques = tecnicasSelecionadas.filter(tech =>
                        (nivel === "Avancado" && ["Drop Set", "Bi-set", "Superset", "FST-7", "Rest-Pause"].includes(tech)) ||
                        (nivel === "Intermediario" && ["Bi-set", "Superset"].includes(tech) && Math.random() < 0.5)
                    );

                    let chanceTecnica;
                    if (nivel === "Avancado") {
                        chanceTecnica = 0.6;
                    } else if (nivel === "Intermediario") {
                        chanceTecnica = 0.3;
                    } else {
                        chanceTecnica = 0.05;
                    }
                    
                    if (applicableTechniques.length > 0 && tecnicasAplicadasNesteDia < maxTecnicasPorDia) {
                        const potentialTechniques = shuffleArray([...applicableTechniques]);
                        for (const tech of potentialTechniques) {
                            if (tech === 'Bi-set' || tech === 'Superset') {
                                const potentialPairedExercises = exerciciosDB.filter(
                                    ex => ex.nome !== exercicio.nome && !exerciciosJaUsadosNoDia.has(ex.nome) && ex.grupoPrimario === exercicio.grupoPrimario && ex.difficulty === exercicio.difficulty && equipamentosSelecionados.some(eq => Array.isArray(ex.equipamento) ? eq.includes(eq) : ex.equipamento === eq)
                                );

                                if (potentialPairedExercises.length > 0) {
                                    pairedExerciseObj = potentialPairedExercises[Math.floor(Math.random() * potentialPairedExercises.length)];
                                    tecnicaAplicada = tech;
                                    tecnicasAplicadasNesteDia++;
                                    exerciciosJaUsadosNoDia.add(pairedExerciseObj.nome);
                                    break;
                                }
                            } else {
                                tecnicaAplicada = tech;
                                tecnicasAplicadasNesteDia++;
                                break;
                            }
                        }
                    }

                    currentDayExercises.push({
                        nome: exercicio.nome,
                        equipamento: Array.isArray(exercicio.equipamento) ? exercicio.equipamento.join(', ') : exercicio.equipamento,
                        series: parseInt(execucaoText.split('x')[0]),
                        reps: execucaoText.split('x')[1],
                        descanso: parseInt(getDescanso(objetivo).replace(' segundos', '')),
                        tecnica: tecnicaAplicada || '',
                        pairedExercise: pairedExerciseObj ? { nome: pairedExerciseObj.nome } : null
                    });

                    if (pairedExerciseObj) {
                        currentDayExercises.push({
                            nome: `${pairedExerciseObj.nome} (Conjugado com ${exercicio.nome})`,
                            equipamento: Array.isArray(pairedExerciseObj.equipamento) ? pairedExerciseObj.equipamento.join(', ') : pairedExerciseObj.equipamento,
                            series: parseInt(execucaoText.split('x')[0]),
                            reps: execucaoText.split('x')[1],
                            descanso: parseInt(getDescanso(objetivo).replace(' segundos', '')),
                            tecnica: tecnicaAplicada,
                            pairedExercise: { nome: exercicio.nome }
                        });
                        exercisesAddedForGroup++; 
                    }
                }
            });

            let cardioText = null;
            if (objetivo === "Emagrecimento" || Math.random() > 0.4) {
                const availableCardio = cardioExercises[nivel];
                if (availableCardio && availableCardio.length > 0) {
                    const cardioEscolhido = availableCardio[Math.floor(Math.random() * availableCardio.length)];
                    cardioText = cardioEscolhido.nome;
                    if (objetivo === "Emagrecimento") {
                        cardioText += " - Mantenha a intensidade para maximizar a queima de gordura!";
                    }
                } else {
                    cardioText = "N√£o foi poss√≠vel gerar um exerc√≠cio de cardio para este n√≠vel.";
                }
            }

            generatedTrainingPlan.push({
                dayLabel: diaLetra,
                muscleGroups: gruposDoDia,
                exercises: currentDayExercises,
                cardio: cardioText,
            });
        });

        displayGeneratedTrainingPlan();
        saveUserData();
    }

    function cleanTextForPdf(text) {
        if (!text) return '';
        const cleaned = text
            .replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{FE00}-\u{FE0F}\u{200D}\u{20E3}]/gu, '')
            .replace(/<strong>(.*?)<\/strong>/g, '$1')
            .replace(/<em>(.*?)<\/em>/g, '$1')
            .replace(/<hr.*?>/g, '\n------------------------------------------------------\n')
            .trim();
        return cleaned;
    }


    function exportarTreinoParaPDF() {
        if (userNivelAcesso !== 'premium') {
            showModal("Este √© um recurso premium. Para exportar seu treino para PDF, por favor, assine nosso plano premium.");
            return;
        }

        if (!treinoGeradoConteudoParaPDF.aluno || treinoGeradoConteudoParaPDF.dias.length === 0) {
            showModal("Por favor, gere um treino primeiro antes de exportar para PDF.");
            return;
        }

        const doc = new window.jspdf.jsPDF();
        const { aluno, idade, peso, altura, sexo, nivel, objetivo, tecnicas, observacoes, dias } = treinoGeradoConteudoParaPDF;
        
        const margin = 15;
        let yOffset = margin;
        const lineHeight = 7;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();


        const addPageContent = () => {
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text("Gerado por seu Treinador Pessoal.", margin, pageHeight - 10);
            doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`, pageWidth - margin, pageHeight - 10, { align: 'right' });

            if (YOUR_LOGO_BASE64_STRING_HERE) {
                const logoWidth = 25;
                const logoHeight = 25;
                doc.addImage(YOUR_LOGO_BASE64_STRING_HERE, 'PNG', pageWidth - margin - logoWidth, margin, logoWidth, logoHeight);
            }
        };

        addPageContent();
        doc.setFontSize(22);
        doc.setTextColor(30, 78, 114);
        doc.text(`Treino Personalizado para ${cleanTextForPdf(aluno)}`, pageWidth / 2, yOffset + 10, { align: 'center' });
        yOffset += lineHeight * 3;

        doc.setDrawColor(200, 200, 200);
        doc.line(margin, yOffset, pageWidth - margin, yOffset);
        yOffset += lineHeight;

        doc.setFontSize(12);
        doc.setTextColor(50, 50, 50);

        doc.text(`Idade: ${idade} anos`, margin, yOffset); yOffset += lineHeight;
        doc.text(`Peso: ${peso} kg`, margin, yOffset); yOffset += lineHeight;
        doc.text(`Altura: ${altura} cm`, margin, yOffset); yOffset += lineHeight;
        doc.text(`Sexo: ${sexo}`, margin, yOffset); yOffset += lineHeight;
        doc.text(`N√≠vel: ${nivel}`, margin, yOffset); yOffset += lineHeight;
        doc.text(`Objetivo: ${objetivo}`, margin, yOffset); yOffset += lineHeight;
        
        const alturaMeters = altura / 100;
        const imc = peso / (alturaMeters * alturaMeters);
        let imcClassification = "";
        if (imc < 18.5) { imcClassification = "Abaixo do peso"; } else if (imc >= 18.5 && imc <= 24.9) { imcClassification = "Peso normal"; } else if (imc >= 25.0 && imc <= 29.9) { imcClassification = "Sobrepeso"; } else { imcClassification = "Obesidade"; }
        const minIdealWeight = 18.5 * (alturaMeters ** 2);
        const maxIdealWeight = 24.9 * (alturaMeters ** 2);

        let tmb;
        if (sexo === 'Masculino') { tmb = (10 * peso) + (6.25 * altura) - (5 * idade) + 5; } else { tmb = (10 * peso) + (6.25 * altura) - (5 * idade) - 161; }
        const activityFactor = (objetivo === "Emagrecimento") ? 1.375 : (objetivo === "Hipertrofia" ? 1.55 : 1.375);
        let caloriesNeeded = tmb * activityFactor;
        if (objetivo === 'Hipertrofia') { caloriesNeeded += 300; } else if (objetivo === 'Emagrecimento') { caloriesNeeded -= 500; }

        doc.text(`IMC: ${imc.toFixed(2)} (${imcClassification})`, margin, yOffset); yOffset += lineHeight;
        doc.text(`Faixa de Peso Ideal: ${minIdealWeight.toFixed(2)} kg - ${maxIdealWeight.toFixed(2)} kg`, margin, yOffset); yOffset += lineHeight;
        doc.text(`TMB (Taxa Metab√≥lica Basal): ${tmb.toFixed(2)} calorias/dia`, margin, yOffset); yOffset += lineHeight;
        doc.text(`Calorias Estimadas para o Objetivo: ${caloriesNeeded.toFixed(2)} calorias/dia`, margin, yOffset); yOffset += lineHeight;
        
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(69, 123, 157);
        const motivationalPhrase = "Disciplina √© o que transforma inten√ß√£o em conquista.";
        const phraseLines = doc.splitTextToSize(motivationalPhrase, pageWidth - 2 * margin);
        doc.text(phraseLines, pageWidth / 2, yOffset + lineHeight, { align: 'center' });
        yOffset += lineHeight * (phraseLines.length + 1);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(50, 50, 50);
        yOffset += lineHeight;


        if (tecnicas.length > 0) {
            doc.text(`T√©cnicas Avan√ßadas: ${tecnicas.join(', ')}`, margin, yOffset);
            yOffset += lineHeight;
        }
        if (observacoes) {
            const obsLines = doc.splitTextToSize(`Observa√ß√µes: ${cleanTextForPdf(observacoes)}`, pageWidth - 2 * margin);
            doc.text(obsLines, margin, yOffset);
            yOffset += lineHeight * obsLines.length;
        }
        yOffset += lineHeight;

        doc.line(margin, yOffset, pageWidth - margin, yOffset);
        yOffset += lineHeight * 1.5;

        dias.forEach((dia, index) => {
            const minSpaceForDay = 4 * lineHeight + 20;
            if (yOffset + minSpaceForDay > pageHeight - margin) {
                doc.addPage();
                yOffset = margin;
                addPageContent();
                yOffset += lineHeight * 2;
            }

            doc.setFontSize(16);
            doc.setTextColor(30, 78, 114);
            doc.text(`DIA ${dia.dayName}: ${dia.groups.join(' + ')}`, margin, yOffset);
            yOffset += lineHeight * 1.5;

            doc.setFontSize(12);
            doc.setTextColor(50, 50, 50);
            doc.text('Aquecimento Geral (5-10 min):', margin, yOffset);
            yOffset += lineHeight;
            dia.warmup.forEach(item => {
                const warmupItemLines = doc.splitTextToSize(`  - ${cleanTextForPdf(item)}`, pageWidth - 2 * margin);
                doc.text(warmupItemLines, margin, yOffset);
                yOffset += lineHeight * warmupItemLines.length;
            });
            yOffset += lineHeight;

            const tableHeaders = [['Exerc√≠cio', 'Equipamento', 'S√©ries/Repeti√ß√µes', 'Descanso', 'T√©cnica']];
            const tableData = dia.exercises.map(ex => [
                cleanTextForPdf(ex.nome),
                cleanTextForPdf(ex.equipamento),
                cleanTextForPdf(ex.execucao),
                cleanTextForPdf(ex.descanso),
                cleanTextForPdf(ex.tecnica || '-')
            ]);

            if (tableData.length > 0) {
                 doc.autoTable({
                    startY: yOffset,
                    head: tableHeaders,
                    body: tableData,
                    theme: 'grid',
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 2,
                        lineColor: 200,
                        lineWidth: 0.1,
                        overflow: 'linebreak'
                    },
                    headStyles: {
                        fillColor: [69, 123, 157],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        textColor: [50, 50, 50]
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: (data) => {
                        addPageContent();
                    }
                });
                yOffset = doc.autoTable.previous.finalY + lineHeight;
            } else {
                doc.text("Nenhum exerc√≠cio gerado para este dia.", margin, yOffset);
                yOffset += lineHeight * 2;
            }
           
            if (dia.cardio) {
                if (yOffset + 2 * lineHeight > pageHeight - margin) {
                    doc.addPage();
                    yOffset = margin;
                    addPageContent();
                    yOffset += lineHeight * 2;
                }
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);
                const cardioLines = doc.splitTextToSize(`Cardio: ${cleanTextForPdf(dia.cardio)}`, pageWidth - 2 * margin);
                doc.text(cardioLines, margin, yOffset);
                yOffset += lineHeight * cardioLines.length;
            }
            yOffset += lineHeight;

            yOffset += lineHeight * 2;
        });

        if (tecnicas.length > 0) {
            if (yOffset + 4 * lineHeight > pageHeight - margin) {
                doc.addPage();
                yOffset = margin;
                addPageContent();
                yOffset += lineHeight * 2;
            }
            doc.setFontSize(14);
            doc.setTextColor(30, 78, 114);
            doc.text('Explica√ß√£o das T√©cnicas Avan√ßadas:', margin, yOffset);
            yOffset += lineHeight * 1.5;

            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            tecnicas.forEach(tech => {
                if (tecnicasExplanations[tech]) {
                    if (yOffset + 4 * lineHeight > pageHeight - margin) {
                        doc.addPage();
                        yOffset = margin;
                        addPageContent();
                        yOffset += lineHeight * 2;
                        doc.setFontSize(14);
                        doc.setTextColor(30, 78, 114);
                        doc.text('Explica√ß√£o das T√©cnicas Avan√ßadas (Continua√ß√£o):', margin, yOffset);
                        yOffset += lineHeight * 1.5;
                        doc.setFontSize(10);
                        doc.setTextColor(50, 50, 50);
                    }

                    doc.setFont('helvetica', 'bold');
                    const titleLines = doc.splitTextToSize(`- ${tech}:`, pageWidth - 2 * margin - 10);
                    doc.text(titleLines, margin + 5, yOffset);
                    yOffset += lineHeight * titleLines.length;

                    doc.setFont('helvetica', 'normal');
                    const contentLines = doc.splitTextToSize(cleanTextForPdf(tecnicasExplanations[tech]), pageWidth - 2 * margin - 15);
                    doc.text(contentLines, margin + 10, yOffset);
                    yOffset += lineHeight * contentLines.length;
                    yOffset += lineHeight * 0.5;
                }
            });
        }

        const prompt = `Com base em um usu√°rio de n√≠vel ${nivel}, sexo ${sexo}, ${idade} anos de idade, pesando ${peso}kg e ${altura}cm de altura, com o objetivo de ${objetivo}, forne√ßa 3 dicas adicionais concisas e acion√°veis para sua jornada fitness. Foque *apenas* em alimenta√ß√£o, suplementa√ß√£o, descanso e hidrata√ß√£o. Responda em portugu√™s. Formate cada dica como "1. **T√≠tulo da Dica**: Conte√∫do da dica."`;

        fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${YOUR_GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro na API do Gemini: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            let llmTips = "1. **Alimenta√ß√£o Saud√°vel**: Consuma prote√≠nas magras, carboidratos complexos e gorduras saud√°veis para sustentar a energia e a recupera√ß√£o.\n2. **Hidrata√ß√£o Constante**: Beba bastante √°gua ao longo do dia, especialmente antes, durante e depois dos treinos, para otimizar o desempenho e a sa√∫de geral.\n3. **Sono Reparador**: Priorize 7-9 horas de sono de qualidade por noite, essencial para a recupera√ß√£o muscular e hormonal.";
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0 && result.candidates[0].content.parts[0].text) {
                llmTips = result.candidates[0].content.parts[0].text;
            }
            
            if (yOffset + 4 * lineHeight > pageHeight - margin) {
                doc.addPage();
                yOffset = margin;
                addPageContent();
                yOffset += lineHeight * 2;
            }

            doc.setFontSize(14);
            doc.setTextColor(30, 78, 114);
            doc.text('Dicas Adicionais do Especialista:', margin, yOffset);
            yOffset += lineHeight * 1.5;

            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);

            const tipRegex = /(\d+\.\s*\*\*(.*?)\*\*:\s*)([\s\S]*?)(?=\n\d+\.|$)/g;
            let match;
            let currentTipYOffset = yOffset;

            tipRegex.lastIndex = 0;

            while ((match = tipRegex.exec(llmTips)) !== null) {
                const title = match[2];
                const content = match[3].trim();

                if (currentTipYOffset + 4 * lineHeight > pageHeight - margin) {
                    doc.addPage();
                    currentTipYOffset = margin;
                    addPageContent();
                    currentTipYOffset += lineHeight * 2;
                    doc.setFontSize(14);
                    doc.setTextColor(30, 78, 114);
                    doc.text('Dicas Adicionais do Especialista (Continua√ß√£o):', margin, currentTipYOffset);
                    currentTipYOffset += lineHeight * 1.5;
                    doc.setFontSize(10);
                    doc.setTextColor(50, 50, 50);
                }

                doc.setFont('helvetica', 'bold');
                const titleLines = doc.splitTextToSize(`- ${cleanTextForPdf(title)}:`, pageWidth - 2 * margin - 10);
                doc.text(titleLines, margin + 5, currentTipYOffset);
                currentTipYOffset += lineHeight * titleLines.length;

                doc.setFont('helvetica', 'normal');
                const contentLines = doc.splitTextToSize(cleanTextForPdf(content), pageWidth - 2 * margin - 15);
                doc.text(contentLines, margin + 10, currentTipYOffset);
                currentTipYOffset += lineHeight * contentLines.length;
                currentTipYOffset += lineHeight * 0.5;
            }
            yOffset = currentTipYOffset;

            doc.save(`treino_${cleanTextForPdf(aluno).replace(/\s/g, '_').toLowerCase()}.pdf`);
        })
        .catch(error => {
            console.error("Error calling Gemini API for PDF tips:", error);
            if (yOffset + 4 * lineHeight > pageHeight - margin) {
                doc.addPage();
                yOffset = margin;
                addPageContent();
                yOffset += lineHeight * 2;
            }
            doc.setFontSize(14);
            doc.text('Dicas Adicionais do Especialista:', margin, yOffset); yOffset += lineHeight;
            doc.setFontSize(10);
            const lines = doc.splitTextToSize("Lembre-se de descansar adequadamente, manter a consist√™ncia nos treinos e sempre buscar a progress√£o de cargas ou intensidade.", pageWidth - 2 * margin);
            doc.text(lines, margin, yOffset);
            yOffset += lines.length * lineHeight;
            doc.save(`treino_${cleanTextForPdf(aluno).replace(/\s/g, '_').toLowerCase()}.pdf`);
        });
    }

    // Make functions globally accessible
    window.addCustomDay = addCustomDay;
    window.removeCustomDay = removeCustomDay;
    window.gerarTreino = gerarTreino;
    window.exportarTreinoParaPDF = exportarTreinoParaPDF;
    window.showModal = showModal;
    window.closeModal = closeModal;
    window.openEditExerciseModal = openEditExerciseModal;
    window.saveEditedExercise = saveEditedExercise;
    window.removeExerciseFromGeneratedPlan = removeExerciseFromGeneratedPlan;
    window.openAddExerciseToDayModal = openAddExerciseToDayModal;
    window.populateAddExSelect = populateAddExSelect;
    window.addNewExerciseToDay = addNewExerciseToDay;
    window.updateAddExerciseGroupOptions = updateAddExerciseGroupOptions;
    window.handleAuth = handleAuth;
    window.logout = logout;
    window.upgradeToPremium = upgradeToPremium;
    
    </script>
</body>
</html>
